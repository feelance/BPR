@page "/imageproduct"
@using ShoeInc.Data
@using ShoeInc.Repositories.Products
@inject ProductRepository ProductRepository
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@implements IDisposable

<!-- Author: Florin Bordei --> 

<h3>Add a new product</h3>



<style>
    form .row {
        margin-bottom: 16px;
    }
</style>

<!-- Radzen component with the binded values for the new Product and the 
Submit method to store the new Product in the db. -->

<RadzenTemplateForm Data="@Product" Submit="@((Product product) => { Submit(product); })">
        <div class="row">
        <div class="col-md-6">
            <RadzenFieldset Text="Add a new product ">
              
                <div class="row">
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Brand" />
                    </div>
                    <div class="col-md-8">
                        <RadzenTextBox style="width: 100%;" Name="Brand" @bind-Value="Product.Brand" />
                    </div>
                </div>
                
                  <div class="row">
                                    <div class="col-md-4 align-items-center d-flex">
                                        <RadzenLabel Text="Model" />
                                    </div>
                                    <div class="col-md-8">
                                        <RadzenTextBox style="width: 100%;" Name="Model" @bind-Value="Product.Model" />
                                    </div>
                                </div>
            
                <div class="row">
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="ModelCode" />
                    </div>
                    <div class="col-md-8">
                        <RadzenTextBox style="width: 100%;" Name="ModelCode" @bind-Value="Product.ModelCode" />
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Description" />
                        </div>
                    <div class="col-md-8">
                        <RadzenTextBox style="width: 100%;" Name="ModelCode" @bind-Value="Product.Description" />
                        </div>
                    </div>
                
                <div class="row">
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Stock Level" />
                    </div>
                    <div class="col-md-3">
                        <RadzenNumeric Placeholder="300" style="width: 100%;" Name="Stock Level" @bind-Value="Product.StockLevel" />
                    </div>   </div>
                
                <div class="row">
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Price" />
                    </div>
                    <div class="col-md-3">
                        <RadzenNumeric Placeholder="300" style="width: 100%;" Name="Price" @bind-Value="Product.Price" />
                    </div>   
                </div>
                
                <div class="row">
                    
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Discount"/>
                    </div>
                    <div class="col-md-3">
                        <RadzenNumeric Placeholder="300" style="width: 100%;" Name="Price" @bind-Value="Product.Discount"/>
                    </div>
                </div>
                
                 <div class="row">
                     <div class="col-md-4 align-items-center d-flex">
                         <label>Image:</label>
                         </div>
                     <div class="col-md-3">
                         <InputFile OnChange="@OnFileSelection" />
                         </div>
                     </div>
                
                
                
            </RadzenFieldset>
               <div class="row justify-content-center">
                      <div class="col-md-12 d-flex align-items-end justify-content-center" style="margin-top: 16px;">
                                         <RadzenButton ButtonType="ButtonType.Submit" Icon="save" Text="Save" style="display: inline-block; margin-left: 10px;" />
                                         <RadzenButton ButtonStyle="ButtonStyle.Light" Icon="cancel" style="display: inline-block; margin-left: 10px;" Text="Cancel" Click="@Cancel" />
                          </div>
                    </div>
        </div>
        </div>
    </RadzenTemplateForm>

<div class="col-xl-6">
    <RadzenFieldset Text="Product Image" >              
    <div class="row">

        <div class="col-xl-6">
            <RadzenImage Path="@_imgSrc" Style="width: 100%;">
            </RadzenImage>
        </div>
    </div>
        </RadzenFieldset>
</div>

@code
{
    private Product Product { get; set; } = new Product();
    string _imgSrc = "";

    public async Task OnFileSelection(InputFileChangeEventArgs e)
     {
        // Obtaining the uploaded file
         IBrowserFile img = e.File;
        // The file is turned into a new byte 
         var buffers = new byte[img.Size];
         await img.OpenReadStream().ReadAsync(buffers);
         string imagetype = img.ContentType;
        // The image lik is obtained 
         _imgSrc = $"data:{imagetype};base64,{Convert.ToBase64String(buffers)}";

        Product.Image = buffers;
        Product.ImageUrl = _imgSrc;

     }
    


    private void Submit(Product product)
    {
        // New product is saved in the db 
        ProductRepository.CreateProduct(product);
        NavigationManager.NavigateTo("/ListOfProducts");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/ListOfProducts");
    }


    public void Dispose()
    {
        DialogService?.Dispose();
    }
}

